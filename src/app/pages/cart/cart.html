<main class="container mx-auto py-12 px-4">
  <h2 class="text-4xl font-bold text-gray-800 mb-8 border-b pb-4">
    <span *ngIf="!showCheckoutForm">Seu Carrinho ShopLab</span>
    <span *ngIf="showCheckoutForm">Finalizar Pedido</span>
  </h2>

  <div class="md:grid md:grid-cols-3 md:gap-8">
    
    <div class="md:col-span-2 space-y-8">

      <ng-container *ngIf="!showCheckoutForm">
        
        <ng-container *ngIf="cartItems$ | async as items; else emptyCart">
          
          <div *ngFor="let item of items" class="bg-white p-4 shadow rounded-lg flex items-center">
            
            <div class="flex-grow">
              <h3 class="text-lg font-semibold text-gray-900">{{ item.title }}</h3>
              <p class="text-sm text-gray-600">Preço Unitário: R$ {{ item.price.toFixed(2) }}</p>
              <p class="text-sm font-bold text-indigo-600">Total: R$ {{ (item.price * item.quantity).toFixed(2) }}</p>
            </div>

            <div class="flex items-center space-x-4">
              <span class="text-xl font-bold">x{{ item.quantity }}</span>
              <button 
                (click)="onRemoveItem(item.id)"
                class="text-red-500 hover:text-red-700 transition duration-150 p-2 rounded-full border border-red-500 hover:border-red-700">
                Remover
              </button>
            </div>
          </div>
          
        </ng-container>

        <ng-template #emptyCart>
          <div class="text-center py-10 bg-white rounded-lg shadow-lg">
            <p class="text-xl text-gray-500">Seu carrinho está vazio. Adicione alguns e-books!</p>
            <a routerLink="/produtos" class="mt-4 inline-block text-indigo-600 hover:underline">Ir para Produtos</a>
          </div>
        </ng-template>
        
      </ng-container>

      <ng-container *ngIf="showCheckoutForm">
        <form [formGroup]="checkoutForm" (ngSubmit)="onCheckout()" class="bg-white p-6 shadow-xl rounded-lg space-y-6">
          <h3 class="text-xl font-bold text-gray-800 border-b pb-3 mb-4">Informações de Envio e Pagamento</h3>

          <div>
            <label for="name" class="block text-sm font-medium text-gray-700">Nome Completo</label>
            <input id="name" type="text" formControlName="name" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
            <div *ngIf="checkoutForm.get('name')?.invalid && (checkoutForm.get('name')?.dirty || checkoutForm.get('name')?.touched)" class="text-red-500 text-sm mt-1">
              <span *ngIf="checkoutForm.get('name')?.errors?.['required']">Nome é obrigatório.</span>
              <span *ngIf="checkoutForm.get('name')?.errors?.['minlength']">Nome deve ter no mínimo 3 caracteres.</span>
            </div>
          </div>

          <div>
            <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
            <input id="email" type="email" formControlName="email" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
            <div *ngIf="checkoutForm.get('email')?.invalid && (checkoutForm.get('email')?.dirty || checkoutForm.get('email')?.touched)" class="text-red-500 text-sm mt-1">
              <span *ngIf="checkoutForm.get('email')?.errors?.['required']">Email é obrigatório.</span>
              <span *ngIf="checkoutForm.get('email')?.errors?.['email']">Email inválido.</span>
            </div>
          </div>
          
          <div>
            <label for="address" class="block text-sm font-medium text-gray-700">Endereço de Cobrança (Fictício)</label>
            <input id="address" type="text" formControlName="address" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
            <div *ngIf="checkoutForm.get('address')?.invalid && (checkoutForm.get('address')?.dirty || checkoutForm.get('address')?.touched)" class="text-red-500 text-sm mt-1">
              <span>Endereço é obrigatório.</span>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Método de Pagamento</label>
            <select formControlName="paymentMethod" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
              <option value="pix">PIX (Mais Rápido)</option>
              <option value="credit">Cartão de Crédito (Simulado)</option>
            </select>
            </div>

          <div class="flex justify-between items-center pt-4">
            <button type="button" (click)="showCheckoutForm = false" class="text-indigo-600 hover:text-indigo-800">
                ← Voltar ao Carrinho
            </button>
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-8 rounded-lg transition duration-300">
              Finalizar Pedido
            </button>
          </div>
        </form>
      </ng-container>

    </div>

    <div *ngIf="(cartItems$ | async)?.length" class="md:col-span-1 mt-8 md:mt-0">
      <div class="bg-white p-6 shadow-2xl rounded-lg sticky top-4">
        <h3 class="text-2xl font-bold border-b pb-3 mb-4 text-gray-800">Resumo do Pedido</h3>
        
        <div class="flex justify-between text-lg font-semibold mb-6">
          <span>Total a Pagar:</span>
          <span class="text-indigo-600">R$ {{ subtotal$ | async | number:'1.2-2' }}</span>
        </div>
        
        <button 
          *ngIf="!showCheckoutForm"
          (click)="goToCheckout()"
          class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition duration-300">
          Avançar para Checkout
        </button>
      </div>
    </div>

  </div>
</main>